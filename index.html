<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' data: https://unpkg.com https://cdn.jsdelivr.net ws://localhost:7645; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://static.cloudflareinsights.com; style-src 'self' 'unsafe-inline'; connect-src 'self' http://localhost:7645 ws://localhost:7645 https://unpkg.com https://cdn.jsdelivr.net https://cloudflareinsights.com; img-src 'self' data:;">
    <title>機台面板 | 碩論進行中</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">

    <!-- 預先載入關鍵 LCP 資源 -->
    <link rel="preload" as="image" href="assets/ui/panel.webp" type="image/webp">

    <!-- 主要樣式 -->
    <link rel="stylesheet" href="css/style.css">
    <!-- QR Code 函式庫 -->
    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
</head>

<body>
    <!-- 頂部空間佔位 -->
    <div class="top-spacer-placeholder" id="topSpacerPlaceholder"></div>

    <!-- 可縮放主區域 -->
    <div class="scalable-area" id="scalableArea">
        <!-- 媒體顯示區 -->
        <div class="media-area" id="mediaArea"></div>

        <!-- 按鈕群組區 -->
        <div class="button-group-container" id="buttonGroupContainer">
            <!-- 16 個操作按鈕 -->
            <button class="button-overlay" style="left:63.73px;top:187.84px;" data-label="B1"><span
                    class="button-label-text">B1</span></button>
            <button class="button-overlay" style="left:118.31px;top:187.84px;" data-label="B2"><span
                    class="button-label-text">B2</span></button>
            <button class="button-overlay" style="left:172.9px;top:187.84px;" data-label="B3"><span
                    class="button-label-text">B3</span></button>
            <button class="button-overlay" style="left:227.48px;top:187.84px;" data-label="B4"><span
                    class="button-label-text">B4</span></button>
            <button class="button-overlay" style="left:302.49px;top:32.61px;" data-label="B5"><span
                    class="button-label-text">B5</span></button>
            <button class="button-overlay" style="left:354.99px;top:32.61px;" data-label="B6"><span
                    class="button-label-text">B6</span></button>
            <button class="button-overlay" style="left:407.48px;top:32.61px;" data-label="B7"><span
                    class="button-label-text">B7</span></button>
            <button class="button-overlay" style="left:302.49px;top:84.35px;" data-label="B8"><span
                    class="button-label-text">B8</span></button>
            <button class="button-overlay" style="left:354.99px;top:84.35px;" data-label="B9"><span
                    class="button-label-text">B9</span></button>
            <button class="button-overlay" style="left:407.48px;top:84.35px;" data-label="B10"><span
                    class="button-label-text">B10</span></button>
            <button class="button-overlay" style="left:302.49px;top:136.1px;" data-label="B11"><span
                    class="button-label-text">B11</span></button>
            <button class="button-overlay" style="left:354.99px;top:136.1px;" data-label="B12"><span
                    class="button-label-text">B12</span></button>
            <button class="button-overlay" style="left:407.48px;top:136.1px;" data-label="B13"><span
                    class="button-label-text">B13</span></button>
            <button class="button-overlay" style="left:302.49px;top:187.84px;" data-label="B14"><span
                    class="button-label-text">B14</span></button>
            <button class="button-overlay" style="left:354.99px;top:187.84px;" data-label="B15"><span
                    class="button-label-text">B15</span></button>
            <button class="button-overlay" style="left:407.48px;top:187.84px;" data-label="B16"><span
                    class="button-label-text">B16</span></button>
        </div>

        <!-- 面板 WebP 圖片 -->
        <img src="assets/ui/panel.webp" alt="機台操作面板" class="svg-panel" width="496" height="264" fetchpriority="high" />

        <!-- 電源開關與燈號區塊 -->
        <div class="panel-bottom-row" id="panelBottomRow" style="display: flex;">
            <!-- 電源開關區 -->
            <div class="power-switch-area" id="powerSwitchArea"
                style="position: relative; width:189px; height:189px; display: none;">
                <img src="assets/ui/power/power_base.webp" class="power-base-img" alt="Power Base"
                    style="width:100%;height:100%;position:absolute;left:0;top:0;">
                <img src="assets/ui/power/power_knob.webp" class="power-knob-img" id="powerKnob" alt="Power Knob"
                    style="position:absolute;left:50%;top:50%;width:100%;height:100%;transform:translate(-50%,-50%) scale(0.95);transition:transform 0.3s;">
            </div>
            <!-- 狀態燈號區 -->
            <div class="power-light-area" id="powerLightArea"
                style="position: relative; width:95px; height:95px; display: none;">
                <img src="assets/ui/power/power_light_off.webp" class="power-light-off-img" alt="Power Light Off"
                    style="width:100%;height:100%;position:absolute;left:0;top:0;">
                <img src="assets/ui/power/power_light_on.webp" class="power-light-on-img" id="powerLightOn"
                    alt="Power Light On" style="width:100%;height:100%;position:absolute;left:0;top:0;display:none;">
            </div>
        </div>

        <!-- 信用卡參考尺寸卡片 -->
        <div class="reference-card" id="refCard"></div>
    </div>

    <!-- 設定面板 -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-panel-header">
            <strong>設定面板</strong>
            <button id="closeSettingsPanel" class="experiment-close-btn" title="關閉">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <hr class="panel-divider">

        <!-- 面板縮放控制 -->
        <div class="control-group">
            面板縮放:
            <input type="range" id="scaleRange" min="0.5" max="2" step="0.01" value="1.29" />
            <span id="scaleValueSpan">1.29</span>
            <input type="number" id="scaleNumberInput" min="0.5" max="2" step="0.01" value="1.29" />
        </div>

        <!-- 頂部空間控制 -->
        <div class="control-group">
            頂部空間 (vh):
            <input type="range" id="topSpacerRange" min="0" max="50" step="1" value="5" />
            <span id="topSpacerValueSpan">5</span>
            <input type="number" id="topSpacerNumberInput" min="0" max="50" step="1" value="5" />
        </div>


        <!-- 顯示按鈕標記開關 -->
        <div class="control-group">
            <label class="switch">
                <input type="checkbox" id="toggleButtonLabels">
                <div class="slider">
                    <div class="circle"></div>
                </div>
            </label>按鈕標記
        </div>

        <!-- 顯示按鈕顏色開關 -->
        <div class="control-group">
            <label class="switch">
                <input type="checkbox" id="toggleButtonColors">
                <div class="slider">
                    <div class="circle"></div>
                </div>
            </label>按鈕顏色
        </div>

        <!-- 顯示視覺提示開關 -->
        <div class="control-group">
            <label class="switch">
                <input type="checkbox" id="toggleTouchVisuals">
                <div class="slider">
                    <div class="circle"></div>
                </div>
            </label>視覺提示
        </div>

        <hr class="panel-divider">

        <!-- 媒體控制區 -->
        <div class="control-group">媒體控制</div>
        <div class="control-group indented with-gap">
            <button id="powerOnBtn" class="media-power-btn power-on">開機</button>
            <button id="powerOffBtn" class="media-power-btn power-off">關機</button>
        </div>
        <div class="control-group indented with-gap">
            <button id="quickPowerOnBtn" class="media-power-btn quick-power">快速開機</button>
            <button id="emergencyStopBtn" class="media-power-btn emergency-stop">緊急停止</button>
        </div>
        <div class="control-group indented">
            <label class="switch">
                <input type="checkbox" id="toggleMediaAreaMarker">
                <div class="slider">
                    <div class="circle"></div>
                </div>
            </label>顯示媒體區域標記
        </div>
        <div class="control-group indented">
            <label class="switch">
                <input type="checkbox" id="toggleMediaContent">
                <div class="slider">
                    <div class="circle"></div>
                </div>
            </label>顯示媒體內容
        </div>

        <hr class="panel-divider">

        <!-- 聲音設定區 -->
        <div class="control-group">音效設定</div>
        <div class="control-group indented">
            <label class="switch">
                <input type="checkbox" id="toggleBeepSound">
                <div class="slider">
                    <div class="circle"></div>
                </div>
            </label>開啟音效
        </div>

        <hr class="panel-divider">

        <!-- 版本資訊 -->
        <div class="version-info-compact">
            <span class="version-label">版本:</span>
            <span class="version-value" id="appVersion">載入中...</span>
        </div>
    </div>

    <!-- 右側控制按鈕 -->
    <div class="corner-buttons">
        <!-- 全螢幕按鈕 -->
        <button class="circular-button circular-button.primary" id="fullscreenButton" title="切換全螢幕">
            <svg class="svg-icon fullscreen-enter" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="square" stroke-linejoin="miter">
                <path d="M4 9V4h5M20 9V4h-5M4 15v5h5M20 15v5h-5" />
            </svg>
            <svg class="svg-icon fullscreen-exit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9h6V3" />
                <path d="M21 9h-6V3" />
                <path d="M3 15h6v6" />
                <path d="M21 15h-6v6" />
            </svg>
        </button>

        <!-- 實驗面板按鈕 -->
        <button class="circular-button circular-button.primary" id="experimentPanelButton" title="實驗面板">
            <svg class="svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M8.5 2h7" />
                <path d="M9.5 2v6l-5.4 9.8A3 3 0 0 0 7.1 22h9.8a3 3 0 0 0 2.7-4.9L14.5 8V2" />
                <path d="M13.4 11.4l1.1 2.3" />
                <path d="M15.7 15.9l0.01 0.01" />
            </svg>
        </button>

        <!-- 設定面板按鈕 -->
        <button class="circular-button circular-button.primary" id="toggleButton" title="設定面板">
            <svg class="svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3" />
                <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33a1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82a1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1Z" />
            </svg>
        </button>
    </div>

    <!-- 實驗面板 -->
    <div class="experiment-panel" id="experimentPanel" style="display:none;">
        <div class="experiment-panel-header">
            <strong>實驗面板</strong>
            <button id="closeExperimentPanel" class="experiment-close-btn" title="關閉">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- 實驗內容 -->
        <div class="experiment-content-scroll">
            <!-- 單元組合選擇區域 -->
            <div class="combination-selector-section">
                <h3>單元組合</h3>
                <ul class="experiment-default-list" id="combinationSelector">
                    <!-- 由 script.js 動態載入 -->
                </ul>
            </div>

            <!-- 單元選擇與排序 -->
            <div class="experiment-panel-units">
                <div class="units-header">
                    <span>實驗單元</span>
                    <label class="select-all-checkbox">
                        <input type="checkbox" id="selectAllUnits" checked>
                        <span>全選</span>
                    </label>
                </div>

                <div class="units-list-container">
                    <ul class="experiment-units-list">
                        <!-- 開機卡片 -->
                        <li class="power-option-card startup-card">
                            <label class="unit-checkbox">
                                <input type="checkbox" id="includeStartup" checked>
                            </label>
                            <div class="unit-sort">
                                <div class="unit-title">機器開機</div>
                                <div class="unit-subtitle">POWER_ON • 等待使用者手動開機</div>
                            </div>
                        </li>

                        <!-- 由 script.js 動態載入單元 -->

                        <!-- 關機卡片會在 JavaScript 中動態新增到底部 -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- 實驗控制區 -->
        <div class="experiment-panel-actions" id="experimentPanelActions">
            <!-- 實驗ID輸入與開始 -->
            <div class="experiment-id-row">
                <div class="experiment-id-input-group">
                    <label for="experimentIdInput">實驗ID</label>
                    <input type="text" id="experimentIdInput" class="experiment-id-input" maxlength="10"
                        placeholder="載入中...">
                    <button id="regenerateIdButton" class="regenerate-id-btn" title="重新產生ID">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                            <path d="M21 3v5h-5"></path>
                            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                            <path d="M3 21v-5h5"></path>
                        </svg>
                    </button>
                    <div id="experimentTimer" class="experiment-timer" style="display:none;">花費時間：00:00</div>
                </div>
                <button id="startExperimentButton" class="experiment-start-btn">開始實驗</button>
            </div>
            <!-- 受試者名稱輸入 -->
            <div class="experiment-subject-row">
                <label for="subjectNameInput">受試者名稱:</label>
                <input type="text" id="subjectNameInput" class="experiment-subject-input" placeholder="受試者名稱">
            </div>
            <!-- 實驗進行中控制按鈕 -->
            <div id="experimentControlButtons" style="display:none; gap:10px;">
                <button id="pauseExperimentButton" class="experiment-pause-btn">暫停實驗</button>
                <button id="stopExperimentButton" class="experiment-stop-btn">停止實驗</button>
            </div>
        </div>
    </div>
    </div>

    <!-- 操作日誌面板 -->
    <div class="logger-output" id="loggerOutput" style="display:none;">
        <div class="logger-panel-header">
            <strong>操作日誌</strong>
            <button id="copyLogButton" class="logger-panel-btn" title="複製日誌">
                <svg class="svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <rect x="11" y="11" width="10" height="10" rx="1" ry="1"></rect>
                    <path d="M7 15H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v1"></path>
                </svg>
            </button>
            <button id="minimizeLoggerPanel" class="logger-panel-btn" title="最小化">
                <svg class="svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M7 13l5 5 5-5M12 18V6"></path>
                </svg>
            </button>
            <button id="closeLoggerPanel" class="logger-panel-btn" title="關閉">
                <svg class="svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <hr class="panel-divider">
        <div class="log-content" id="logContent"></div>
        <button id="clearLogButton">清空日誌</button>
        <button id="exportLogButton">匯出日誌 (JSON)</button>
        <button id="showStatsButton">顯示統計</button>
    </div>

    <!-- 左側控制按鈕 -->
    <button class="circular-button circular-button.accent logger-fab-position" id="loggerFabButton" title="操作日誌">
        <svg class="svg-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14,2 14,8 20,8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10,9 9,9 8,9"></polyline>
        </svg>
    </button>

    <!-- BEEP 音效 -->
    <audio id="beepSound" src="assets/audio/beep.mp3" preload="auto"></audio>

    <!-- 全域核心 -->
    <script src="js/core/console-manager.js"></script>
    <script src="js/core/config.js"></script>

    <!-- WebSocket 客戶端（必須在 SyncClient 之前載入） -->
    <script src="js/core/websocket-client.js"></script>

    <!-- 同步客戶端 -->
    <script src="js/sync/sync-client.js"></script>

    <!-- 實驗中樞客戶端 -->
    <script src="js/core/experiment-hub-client.js"></script>
    <script type="module" src="js/sync/experiment-hub-manager.js"></script>

    <!-- 基礎工具 -->
    <script type="module" src="js/core/random-utils.js"></script>
    <script type="module" src="js/core/data-loader.js"></script>

    <!-- 狀態管理 -->
    <script src="js/core/experiment-state-manager.js"></script>

    <!-- 面板 UI 控制 -->
    <script src="js/panel/panel-manager.js"></script>
    <script src="js/panel/panel-ui-controls.js"></script>
    <script src="js/panel/panel-button-manager.js"></script>

    <!-- 面板電源與媒體 -->
    <script src="js/panel/panel-media-manager.js"></script>
    <script src="js/panel/power-logger.js"></script>
    <script src="js/panel/panel-power-control.js"></script>

    <!-- 面板功能 -->
    <script src="js/panel/panel-action-manager.js"></script>
    <script type="module" src="js/panel/combination-selector.js"></script>
    <script src="js/panel/panel-experiment-log.js"></script>
    <script type="module" src="js/panel/panel-experiment-manager.js"></script>
    <script src="js/panel/panel-experiment-sync-receiver.js"></script>

    <!-- 同步系統 -->
    <script src="js/sync/sync-confirm-dialog.js"></script>
    <script src="js/experiment/experiment-sync-manager.js"></script>
    <script type="module" src="js/sync/sync-manager.js"></script>

    <!-- 應用啟動 -->
    <script src="js/core/main.js"></script>

</body>

</html>